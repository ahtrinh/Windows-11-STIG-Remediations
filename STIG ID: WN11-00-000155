<#
.SYNOPSIS
    The Windows PowerShell 2.0 feature must be disabled to mitigate downgrade attacks that bypass modern PowerShell logging.

.NOTES
    Author          : Alex Trinh
    LinkedIn        :
    GitHub          : github.com/ahtrinh
    Date Created    : 2026-01-30
    Last Modified   : 2026-01-30
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-00-000155

.TESTED ON
    Date(s) Tested  :
    Tested By       :
    Systems Tested  :
    PowerShell Ver. :

.USAGE
    Run as Administrator.
    Example syntax:
    PS C:\> .\WN11-00-000155.ps1
#>

$RootFeature   = "MicrosoftWindowsPowerShellV2Root"
$EngineFeature = "MicrosoftWindowsPowerShellV2"

# Disable PowerShell 2.0 (Root disables both Root and Engine)
Disable-WindowsOptionalFeature -Online -FeatureName $RootFeature -NoRestart -ErrorAction SilentlyContinue | Out-Null

# Verify (STIG check passes when neither feature is Enabled)
$results = Get-WindowsOptionalFeature -Online -ErrorAction SilentlyContinue |
    Where-Object { $_.FeatureName -in @($RootFeature, $EngineFeature) } |
    Select-Object FeatureName, State

$enabled = $results | Where-Object { $_.State -eq "Enabled" }

if ($null -eq $enabled) {
    Write-Host "COMPLIANT: PowerShell 2.0 features are not enabled."
} else {
    Write-Host "NON-COMPLIANT: One or more PowerShell 2.0 features are still enabled:"
    $enabled | Format-Table -AutoSize
}
